name: ðŸš€ Deploy + Provisionar PostgreSQL no Railway

on:
  push:
    branches: [main]

jobs:
  provision-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Instalar Railway CLI
        run: npm install -g @railway/cli

      - name: Provisionar PostgreSQL (se ainda nÃ£o existir)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "ðŸ” Verificando variÃ¡veis de ambiente..."
          HAS_DB=$(railway variables --json 2>/dev/null | grep -c '"DATABASE_URL"' || true)
          if [ "$HAS_DB" = "0" ]; then
            echo "ðŸ“¦ DATABASE_URL nÃ£o encontrada â€” adicionando PostgreSQL..."
            railway add --plugin postgresql || echo "âš ï¸  JÃ¡ existe ou erro ao adicionar (ignorando)"
            sleep 10
            echo "âœ… PostgreSQL adicionado!"
          else
            echo "âœ… DATABASE_URL jÃ¡ configurada â€” nada a fazer."
          fi

      - name: Configurar variÃ¡veis de ambiente obrigatÃ³rias
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway variables set NODE_ENV=production || true
          # SESSION_SECRET sÃ³ define se ainda nÃ£o existir
          railway variables --json 2>/dev/null | grep -q '"SESSION_SECRET"' \
            || railway variables set SESSION_SECRET="OrionSaaS$(openssl rand -hex 16)" || true
          echo "âœ… VariÃ¡veis configuradas!"

      - name: âœ… Deploy concluÃ­do
        run: echo "ðŸŽ‰ Railway vai redeployar automaticamente a partir do push no GitHub."
