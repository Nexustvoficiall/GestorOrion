<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestor Orion">
    <meta name="theme-color" content="#e53935">
    <meta name="description" content="Gestor IPTV SaaS — painel de controle para revendedores">
    <title>Gestor Orion</title>
    <link rel="manifest" href="/dashboard/manifest.json">
    <link rel="stylesheet" href="style.css?v=3">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="bg"></div>
<div class="lightning"></div>

<header class="topbar">
    <div class="logo-block">
        <img id="topLogoImg" class="logo-img" src="/dashboard/assets/logo.png" alt="logo" style="display:block">
        <span id="topLogoIcon" class="logo-icon" style="display:none">&#10022;</span>
        <div>
            <h1 id="siteTitle">GESTOR ORION</h1>
            <span class="tag">PLATAFORMA DE GEST&Atilde;O IPTV</span>
        </div>
    </div>
    <div class="topbar-right">
        <div id="licenseBanner" style="display:none"></div>
        <div class="user-info">
            <span class="user-icon">&#128100;</span>
            <div>
                <span id="topUsername" class="top-user">-</span>
                <span id="topRole" class="top-role">-</span>
            </div>
        </div>
        <button class="btn-logout" onclick="doLogout()">&#9211; SAIR</button>
    </div>
</header>

<nav class="tabs">
    <button class="tab-btn active" data-tab="painel"     onclick="switchTab('painel')">&#11041; PAINEL</button>
    <button class="tab-btn"        data-tab="clientes"   onclick="switchTab('clientes')">&#128101; CLIENTES</button>
    <button class="tab-btn"        data-tab="revendas"   onclick="switchTab('revendas')">&#127978; REVENDAS</button>
    <button class="tab-btn"        data-tab="servidores" onclick="switchTab('servidores')">&#128421; SERVIDORES</button>
    <button class="tab-btn"        data-tab="financeiro" onclick="switchTab('financeiro')">&#128202; FINANCEIRO</button>
    <button class="tab-btn"        data-tab="perfil"    onclick="switchTab('perfil')">&#9881; MEU PERFIL</button>
    <button class="tab-btn admin-tab" id="tabAdmin" data-tab="admin" onclick="switchTab('admin')" style="display:none">&#9873; ADMIN</button>
</nav>

<main>

<!-- ABA PAINEL -->
<div id="tab-painel" class="tab-content active">
    <section class="metrics">
        <div class="card big"><h3>CLIENTES</h3><p id="m_clients">0</p></div>
        <div class="card big"><h3>REVENDAS</h3><p id="m_resellers">0</p></div>
        <div class="card big"><h3>RECEITA</h3><p id="m_revenue">R$ 0,00</p></div>
        <div class="card big"><h3>GASTOS TOTAIS</h3><p id="m_cost">R$ 0,00</p></div>
        <div class="card big highlight"><h3>LUCRO L&Iacute;QUIDO</h3><p id="m_profit">R$ 0,00</p></div>
        <div class="card big"><h3>MARGEM</h3><p id="m_margin">0%</p></div>
        <div class="card big"><h3>PROJE&Ccedil;&Atilde;O MENSAL</h3><p id="m_projected">R$ 0,00</p></div>
    </section>
    <section class="panel">
        <h2>GASTOS POR SERVIDOR</h2>
        <div id="costList" class="cost-list"></div>
    </section>
    <section class="panel">
        <h2>&#127942; RANKING DE REVENDAS (LUCRO)</h2>
        <div id="resellerRanking" class="cost-list"></div>
    </section>
    <section class="panel panel-alert">
        <h2>&#9888;&#65038; VENCIMENTOS PR&Oacute;XIMOS &mdash; 7 DIAS</h2>
        <div class="alerts-grid">
            <div>
                <h3 class="alert-sub">&#9656; CLIENTES</h3>
                <div id="alertClients" class="alert-list"><span class="empty-alert">Nenhum</span></div>
            </div>
            <div>
                <h3 class="alert-sub">&#9656; REVENDAS</h3>
                <div id="alertResellers" class="alert-list"><span class="empty-alert">Nenhuma</span></div>
            </div>
        </div>
    </section>
</div>

<!-- ABA CLIENTES -->
<div id="tab-clientes" class="tab-content">
    <section class="panel">
        <h2>NOVO CLIENTE</h2>
        <div class="form-row">
            <div class="field"><label>Nome</label><input id="name" placeholder="Nome completo"></div>
            <div class="field"><label>Usu&aacute;rio</label><input id="username" placeholder="Username"></div>
            <div class="field"><label>Senha</label><input id="password" type="password" placeholder="Senha"></div>
            <div class="field"><label>WhatsApp</label><input id="whatsapp" placeholder="Ex: 11999998888" type="tel"></div>
            <div class="field">
                <label>Plano</label>
                <select id="planType">
                    <option value="30">Mensal (30d)</option>
                    <option value="90">Trimestral (90d)</option>
                    <option value="180">Semestral (180d)</option>
                    <option value="365">Anual (365d)</option>
                </select>
            </div>
            <div class="field"><label>Servidor</label><select id="server"></select></div>
            <div class="field"><label>App</label><input id="app" placeholder="App usado"></div>
            <div class="field"><label>Valor cobrado (R$)</label><input id="planValue" type="number" placeholder="0.00"></div>
            <div class="field"><label>Seu custo (R$)</label><input id="costPerActive" type="number" placeholder="0.00"></div>
            <div class="field btn-field"><button onclick="createClient()">SALVAR CLIENTE</button></div>
        </div>
    </section>
    <section class="panel">
        <div class="panel-header">
            <h2>TODOS OS CLIENTES</h2>
            <div style="display:flex;gap:8px;align-items:center">
                <label style="font-size:10px;color:#555;letter-spacing:1px">FILTRAR:</label>
                <select id="filterClientStatus" onchange="loadClients()" class="filter-select">
                    <option value="">Todos</option>
                    <option value="ATIVO">Ativos</option>
                    <option value="INATIVO">Inativos</option>
                </select>
                <button class="btn-sm" onclick="loadClients()">&#8635;</button>
                <button class="btn-sm" onclick="exportClientesCSV()" title="Exportar CSV para Excel" style="background:var(--accent);color:#000;font-weight:bold">&#8659; CSV</button>
            </div>
        </div>
        <div class="table-wrap">
        <table>
            <thead><tr>
                <th>Nome</th><th>Usu&aacute;rio</th><th>WhatsApp</th><th>Servidor</th><th>Plano</th>
                <th>Valor</th><th>Vencimento</th><th>App</th><th>Status</th><th>A&ccedil;&otilde;es</th>
            </tr></thead>
            <tbody id="clientList"></tbody>
        </table>
        </div>
    </section>
</div>

<!-- ABA REVENDAS -->
<div id="tab-revendas" class="tab-content">
    <section class="panel">
        <h2>NOVA REVENDA</h2>
        <div class="form-row" style="margin-bottom:15px">
            <div class="field"><label>Nome da Revenda</label><input id="r_name" placeholder="Nome"></div>
            <div class="field">
                <label>Tipo</label>
                <select id="r_type" onchange="onTypeChange()">
                    <option value="PRE">PR&Eacute;-PAGO</option>
                    <option value="POS">P&Oacute;S-PAGO</option>
                    <option value="MEN">MENSALISTA</option>
                </select>
            </div>
            <div class="field"><label>WhatsApp</label><input id="r_whatsapp" placeholder="Ex: 11999998888" type="tel"></div>
        </div>
        <div id="serverContainer"></div>
        <div class="btn-row">
            <button class="btn-secondary" onclick="addServer()">+ Adicionar Servidor</button>
            <button onclick="createReseller()">SALVAR REVENDA</button>
        </div>
    </section>
    <section class="panel">
        <div class="panel-header">
            <h2>TODAS AS REVENDAS</h2>
            <div style="display:flex;gap:8px;align-items:center">
                <label style="font-size:10px;color:#555;letter-spacing:1px">FILTRAR:</label>
                <select id="filterResellerStatus" onchange="loadResellers()" class="filter-select">
                    <option value="">Todas</option>
                    <option value="ATIVO">Ativas</option>
                    <option value="INATIVO">Inativas</option>
                </select>
                <button class="btn-sm" onclick="loadResellers()">&#8635;</button>
            </div>
        </div>
        <div class="table-wrap">
        <table>
            <thead><tr>
                <th>Nome</th><th>Tipo</th><th>WhatsApp</th><th>Servidores</th><th>Ativos</th><th>Receita</th>
                <th>Custo</th><th>Acerto (por servidor)</th><th>Pagamento</th><th>Status</th><th>Plano Gestor</th><th>A&ccedil;&otilde;es</th>
            </tr></thead>
            <tbody id="resellerList"></tbody>
        </table>
        </div>
    </section>
</div>

<!-- ABA SERVIDORES -->
<div id="tab-servidores" class="tab-content">
    <section class="panel">
        <h2>GERENCIAR SERVIDORES</h2>
        <p class="panel-desc">Adicione ou remova servidores dispon&iacute;veis para sele&ccedil;&atilde;o em clientes e revendas. Qualquer usu&aacute;rio pode adicionar seus pr&oacute;prios servidores.</p>
        <div class="form-row" style="margin-top:16px;margin-bottom:20px;align-items:flex-end">
            <div class="field" style="flex:2">
                <label>Nome do Servidor</label>
                <input id="newServerName" placeholder="Ex: Ultra Stream, MegaTV...">
            </div>
            <div class="field btn-field">
                <button onclick="createServer()">+ ADICIONAR</button>
            </div>
        </div>
        <div id="serverListUI" class="server-chip-list"></div>
    </section>
</div>

<!-- ABA FINANCEIRO -->
<div id="tab-financeiro" class="tab-content">
    <section class="metrics">
        <div class="card big"><h3>RECEITA TOTAL</h3><p id="f_revenue">R$ 0,00</p></div>
        <div class="card big"><h3>CUSTO TOTAL</h3><p id="f_cost">R$ 0,00</p></div>
        <div class="card big highlight"><h3>LUCRO L&Iacute;QUIDO</h3><p id="f_profit">R$ 0,00</p></div>
    </section>
    <section class="panel">
        <h2>RESUMO FINANCEIRO</h2>
        <div class="chart-wrap"><canvas id="financeChart"></canvas></div>
    </section>
    <section class="panel">
        <h2>GASTOS POR SERVIDOR</h2>
        <div id="costListFin" class="cost-list"></div>
    </section>
    <section class="panel">
        <h2>&#128200; LUCRO POR SERVIDOR</h2>
        <div id="profitByServer" class="cost-list"></div>
    </section>
    <section class="panel">
        <h2>&#127882; SERVIDOR MAIS LUCRATIVO</h2>
        <div id="mostProfitable" class="cost-list"></div>
    </section>
</div>

<!-- ABA PERFIL -->
<div id="tab-perfil" class="tab-content">
    <section class="panel">
        <h2>&#9881; MEU PERFIL</h2>
        <div class="perfil-grid">

            <!-- Logo -->
            <div class="perfil-card">
                <h3>&#128247; Logo do Sistema</h3>
                <div class="logo-preview-wrap">
                    <div id="logoPlaceholder" class="logo-placeholder">&#10022;</div>
                    <img id="logoPreviewImg" class="logo-preview" src="" alt="logo preview">
                    <div class="logo-actions">
                        <label class="btn btn-sm" style="cursor:pointer;display:inline-block;padding:6px 14px;background:var(--accent3);border:1px solid var(--accent);color:#fff;font-size:10px;letter-spacing:1px;text-transform:uppercase;font-family:'Orbitron',sans-serif">
                            &#128194; ESCOLHER
                            <input type="file" id="logoFileInput" accept="image/*" style="display:none" onchange="uploadLogo(this)">
                        </label>
                        <button class="btn-sm btn-secondary" onclick="removeLogo()">&#10005; REMOVER</button>
                    </div>
                </div>
            </div>

            <!-- Nome de Usuário -->
            <div class="perfil-card">
                <h3>&#128100; Nome de Usu&aacute;rio</h3>
                <div class="perfil-row">
                    <label>Usu&aacute;rio atual</label>
                    <input id="usernameInput" placeholder="Novo nome de usuário" maxlength="40" autocomplete="off">
                </div>
                <div class="perfil-row">
                    <label>Confirmar com senha atual</label>
                    <input id="usernamePassword" type="password" placeholder="Sua senha" autocomplete="off">
                </div>
                <button onclick="changeUsername()">SALVAR USU&Aacute;RIO</button>
                <div id="usernameMsg" class="pwd-msg"></div>
            </div>

            <!-- Tema de Cor -->
            <div class="perfil-card">
                <h3>&#127752; Cor do Sistema</h3>
                <p style="font-size:11px;color:var(--text-muted);margin-bottom:14px;letter-spacing:1px">Selecione a cor que ser&aacute; aplicada em todo o painel</p>
                <div class="tema-btns">
                    <div class="tema-option" onclick="setTheme('red')">
                        <div class="tema-dot t-red theme-btn" data-theme="red"></div>
                        <span class="tema-name">VERMELHO</span>
                    </div>
                    <div class="tema-option" onclick="setTheme('blue')">
                        <div class="tema-dot t-blue theme-btn" data-theme="blue"></div>
                        <span class="tema-name">AZUL</span>
                    </div>
                    <div class="tema-option" onclick="setTheme('yellow')">
                        <div class="tema-dot t-yellow theme-btn" data-theme="yellow"></div>
                        <span class="tema-name">AMARELO</span>
                    </div>
                    <div class="tema-option" onclick="setTheme('purple')">
                        <div class="tema-dot t-purple theme-btn" data-theme="purple"></div>
                        <span class="tema-name">ROXO</span>
                    </div>
                    <div class="tema-option" onclick="setTheme('green')">
                        <div class="tema-dot t-green theme-btn" data-theme="green"></div>
                        <span class="tema-name">VERDE</span>
                    </div>
                </div>
            </div>

            <!-- Alterar Senha -->
            <div class="perfil-card">
                <h3>&#128274; Alterar Senha</h3>
                <div class="perfil-row"><label>Senha Atual</label><input id="pwd_current" type="password" placeholder="Senha atual"></div>
                <div class="perfil-row"><label>Nova Senha</label><input id="pwd_new" type="password" placeholder="Nova senha"></div>
                <div class="perfil-row"><label>Confirmar Nova Senha</label><input id="pwd_confirm" type="password" placeholder="Repita a nova senha"></div>
                <button onclick="changePwd()">ALTERAR SENHA</button>
                <div id="pwdMsg" class="pwd-msg"></div>
            </div>

        </div>
    </section>
</div>

<!-- ABA ADMIN -->
<div id="tab-admin" class="tab-content">
    <!-- Gestão de Licença -->
    <section class="panel">
        <h2>&#128273; LICENÇA DO SISTEMA</h2>
        <div id="licenseInfo" style="margin-bottom:16px;padding:14px;border:1px solid var(--accent3);font-size:12px;letter-spacing:1px;line-height:2"></div>
        <div class="form-row">
            <div class="field"><label>Validade da Licença</label><input id="lic_expiration" type="date"></div>
            <div class="field">
                <label>Plano</label>
                <select id="lic_plan">
                    <option value="BASICO">B&Aacute;SICO</option>
                    <option value="PRO">PRO</option>
                    <option value="ENTERPRISE">ENTERPRISE</option>
                </select>
            </div>
            <div class="field">
                <label>Status</label>
                <select id="lic_active">
                    <option value="1">ATIVO</option>
                    <option value="0">BLOQUEADO</option>
                </select>
            </div>
            <div class="field btn-field"><button onclick="saveLicense()">SALVAR LICENÇA</button></div>
        </div>
    </section>
    <!-- Criar usuário revendedor -->
    <section class="panel">
        <h2>&#128273; CRIAR ACESSO PARA REVENDEDOR</h2>
        <p class="panel-desc">Gere um login para um revendedor acessar o painel. Escolha o per&iacute;odo de licen&ccedil;a &mdash; apenas <strong>Plano Standard</strong> dispon&iacute;vel.</p>

        <!-- Linha 1: dados de acesso -->
        <div class="form-row" style="margin-top:16px">
            <div class="field"><label>Usu&aacute;rio</label><input id="nu_username" placeholder="Ex: joao123" autocomplete="off"></div>
            <div class="field"><label>Senha</label><input id="nu_password" type="password" placeholder="Senha de acesso" autocomplete="new-password"></div>
            <div class="field">
                <label>Perfil</label>
                <select id="nu_role" onchange="onNuRoleChange()">
                    <option value="reseller">Revendedor</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
        </div>

        <!-- Cards de plano (visíveis só para Revendedor) -->
        <div id="nu_plan_wrap" style="margin-top:18px">
            <label style="font-size:10px;letter-spacing:2px;color:var(--text-muted,#888);display:block;margin-bottom:10px">PLANO DE ACESSO AO PAINEL</label>
            <div class="plan-cards">
                <div class="plan-card" data-plan="1m" onclick="selectPlanCard(this,'1m')">
                    <div class="plan-card-period">1 M&Ecirc;S</div>
                    <div class="plan-card-label">Standard</div>
                    <div class="plan-card-days">30 dias</div>
                </div>
                <div class="plan-card" data-plan="3m" onclick="selectPlanCard(this,'3m')">
                    <div class="plan-card-period">3 MESES</div>
                    <div class="plan-card-label">Standard</div>
                    <div class="plan-card-days">90 dias</div>
                </div>
                <div class="plan-card plan-card-selected" data-plan="6m" onclick="selectPlanCard(this,'6m')">
                    <div class="plan-card-badge">POPULAR</div>
                    <div class="plan-card-period">6 MESES</div>
                    <div class="plan-card-label">Standard</div>
                    <div class="plan-card-days">180 dias</div>
                </div>
                <div class="plan-card" data-plan="1a" onclick="selectPlanCard(this,'1a')">
                    <div class="plan-card-badge" style="background:var(--accent)">MELHOR</div>
                    <div class="plan-card-period">1 ANO</div>
                    <div class="plan-card-label">Standard</div>
                    <div class="plan-card-days">365 dias</div>
                </div>
            </div>
            <input type="hidden" id="nu_accessPlan" value="6m">

            <!-- Preview da licença -->
            <div id="nu_plan_preview" style="margin-top:14px;padding:12px 16px;border:1px solid var(--accent3,#0055cc);background:var(--accent-dim,#1a6fff11);font-size:11px;letter-spacing:1px;display:flex;gap:32px;align-items:center;flex-wrap:wrap">
                <span>&#128197; <strong>IN&Iacute;CIO:</strong> <span id="prev_start"></span></span>
                <span>&#9200; <strong>EXPIRA&Ccedil;&Atilde;O:</strong> <span id="prev_expiry" style="color:var(--accent2,#4499ff)"></span></span>
                <span>&#128262; <strong>PLANO:</strong> <span id="prev_plan">STANDARD &mdash; 6 MESES</span></span>
            </div>
        </div>

        <div class="btn-row" style="margin-top:18px">
            <button onclick="createUserReseller()" style="min-width:180px">&#43; CRIAR ACESSO</button>
        </div>
    </section>
    <section class="panel">
        <div class="panel-header">
            <h2>USU&Aacute;RIOS DO SISTEMA</h2>
            <button class="btn-sm" onclick="loadUsers()">&#8635;</button>
        </div>
        <div class="table-wrap">
        <table>
            <thead><tr><th>Usu&aacute;rio</th><th>Perfil</th><th>Revenda</th><th>Plano</th><th>Expira em</th><th>A&ccedil;&otilde;es</th></tr></thead>
            <tbody id="userList"></tbody>
        </table>
        </div>
    </section>
    <!-- Audit Log -->
    <section class="panel">
        <div class="panel-header">
            <h2>&#128196; LOG DE AUDITORIA</h2>
            <button class="btn-sm" onclick="loadAuditLog()">&#8635;</button>
        </div>
        <div class="table-wrap">
        <table>
            <thead><tr><th>Data/Hora</th><th>Usu&aacute;rio</th><th>Ação</th><th>Entidade</th><th>IP</th></tr></thead>
            <tbody id="auditList"><tr><td colspan="5" style="text-align:center;color:#555">Clique em &#8635; para carregar</td></tr></tbody>
        </table>
        </div>
    </section>
</div>

</main>

<!-- MODAL DETALHE CLIENTE -->
<div id="modalClient" class="modal-overlay" style="display:none" onclick="if(event.target.id==='modalClient')closeClientModal()">
    <div class="modal-box">
        <div class="modal-header">
            <h2>DETALHE DO CLIENTE</h2>
            <button class="btn-close" onclick="closeClientModal()">&#10005;</button>
        </div>
        <div id="clientDetail" class="detail-grid"></div>
    </div>
</div>

<!-- MODAL EDITAR REVENDA -->
<div id="modalEdit" class="modal-overlay" style="display:none" onclick="closeModal(event)">
    <div class="modal-box">
        <div class="modal-header">
            <h2>EDITAR REVENDA</h2>
            <button class="btn-close" onclick="document.getElementById('modalEdit').style.display='none'">&#10005;</button>
        </div>
        <input type="hidden" id="edit_id">
        <div class="form-row" style="margin-bottom:14px">
            <div class="field"><label>Nome</label><input id="edit_name" placeholder="Nome"></div>
            <div class="field">
                <label>Tipo</label>
                <select id="edit_type">
                    <option value="PRE">PR&Eacute;-PAGO</option>
                    <option value="POS">P&Oacute;S-PAGO</option>
                    <option value="MEN">MENSALISTA</option>
                </select>
            </div>
            <div class="field"><label>WhatsApp</label><input id="edit_whatsapp" placeholder="Ex: 11999998888" type="tel"></div>
            <div class="field">
                <label>Pagamento</label>
                <select id="edit_payment">
                    <option value="PENDENTE">PENDENTE</option>
                    <option value="PAGO">PAGO</option>
                </select>
            </div>
        </div>
        <div id="edit_serverContainer"></div>
        <div class="btn-row" style="margin-bottom:16px">
            <button class="btn-secondary" onclick="addEditServer()">+ Adicionar Servidor</button>
        </div>
        <div class="btn-row">
            <button onclick="saveEditReseller()">SALVAR ALTERA&Ccedil;&Otilde;ES</button>
            <button class="btn-secondary" onclick="document.getElementById('modalEdit').style.display='none'">CANCELAR</button>
        </div>
    </div>
</div>

<!-- MODAL ONBOARDING (primeiro acesso) -->
<div id="modalOnboarding" class="modal-overlay" style="display:none">
    <div class="modal-box" style="max-width:480px;text-align:center">
        <div class="modal-header" style="justify-content:center;border-bottom:1px solid #333;padding-bottom:12px;margin-bottom:4px">
            <h2>&#127881; BEM-VINDO AO GESTOR ORION!</h2>
        </div>
        <div style="padding:16px 0">
            <p style="color:#aaa;font-size:13px;margin-bottom:14px">Voc&ecirc; est&aacute; acessando pela <strong style="color:#fff">primeira vez</strong>.</p>
            <div style="background:#1a1a2e;border:1px solid #333;border-radius:8px;padding:14px;text-align:left;font-size:13px;margin-bottom:14px">
                <div style="margin-bottom:8px;color:#fff">&#128203; O que voc&ecirc; pode fazer aqui:</div>
                <ul style="list-style:none;padding:0;color:#aaa;line-height:2">
                    <li>&#127978; Cadastrar <strong style="color:#fff">revendedores</strong> e gerenciar seus planos</li>
                    <li>&#128100; Cadastrar <strong style="color:#fff">clientes</strong> com controle de vencimento</li>
                    <li>&#128187; Gerenciar <strong style="color:#fff">servidores</strong> dispon&iacute;veis</li>
                    <li>&#128202; Visualizar <strong style="color:#fff">relat&oacute;rios</strong> financeiros</li>
                </ul>
            </div>
            <p style="color:#ff9800;font-size:12px">&#9888; Recomendado: altere sua senha na aba <strong>Perfil</strong> antes de come&ccedil;ar.</p>
        </div>
        <button onclick="closeOnboarding()" style="width:100%">COME&Ccedil;AR A USAR &#8594;</button>
    </div>
</div>

<!-- MODAL LINK DE RESET SENHA -->
<div id="modalResetLink" class="modal-overlay" style="display:none" onclick="if(event.target.id==='modalResetLink')document.getElementById('modalResetLink').style.display='none'">
    <div class="modal-box" style="max-width:460px">
        <div class="modal-header">
            <h3>&#128273; Link de Reset de Senha</h3>
            <button class="btn-close" onclick="document.getElementById('modalResetLink').style.display='none'">&#10005;</button>
        </div>
        <div style="padding:14px 0">
            <p style="color:#aaa;font-size:13px;margin-bottom:12px">Copie o link abaixo e envie para o usu&aacute;rio (v&aacute;lido por 24h):</p>
            <div style="display:flex;gap:8px">
                <input id="resetLinkInput" readonly style="flex:1;background:#1e1e30;border:1px solid #333;color:#fff;padding:8px 10px;border-radius:6px;font-size:12px">
                <button class="btn-sm" onclick="copyResetLink()" style="white-space:nowrap">&#128203; Copiar</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL PLANO GESTOR (REVENDA) -->
<div id="modalPlan" class="modal-overlay" style="display:none" onclick="if(event.target.id==='modalPlan')closePlanModal()">
    <div class="modal-box" style="max-width:380px">
        <div class="modal-header">
            <h3 id="modalPlanTitle">Plano Gestor — Revenda</h3>
            <button class="btn-close" onclick="closePlanModal()">&#10005;</button>
        </div>
        <div style="padding:16px 0">
            <p style="color:#aaa;font-size:13px;margin-bottom:12px">Revenda: <strong id="planResellerName" style="color:#fff"></strong></p>
            <div id="planCurrentStatus" style="margin-bottom:16px;font-size:13px"></div>
            <div class="field">
                <label>Meses a adicionar</label>
                <select id="planMonths">
                    <option value="1">1 m&ecirc;s — R$ 20,00</option>
                    <option value="2">2 meses — R$ 40,00</option>
                    <option value="3">3 meses — R$ 60,00</option>
                    <option value="6">6 meses — R$ 120,00</option>
                    <option value="12">12 meses — R$ 240,00</option>
                </select>
            </div>
            <div class="field">
                <label>Valor por m&ecirc;s (R$)</label>
                <input type="number" id="planValueInput" value="20" min="0" step="0.01">
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:8px">
            <button onclick="confirmSetPlan('activate')" style="flex:1">&#10003; ATIVAR / RENOVAR</button>
            <button onclick="confirmSetPlan('cancel')" class="btn-secondary" style="flex:1;background:#c0392b">&#10006; CANCELAR PLANO</button>
        </div>
    </div>
</div>

<script src="dashboard.js?v=3"></script>
<script>
    // Limpa SWs antigos e registra o novo
    if ('serviceWorker' in navigator) {
        // Desregistra qualquer SW antigo (cache-first) antes de registrar o novo
        navigator.serviceWorker.getRegistrations().then(regs => {
            const stale = regs.filter(r => !r.active || r.active.scriptURL.includes('sw.js'));
            Promise.all(stale.map(r => r.unregister())).then(() => {
                navigator.serviceWorker.register('/dashboard/sw.js?v=3')
                    .then(reg => {
                        // Foraça ativação imediata do novo SW
                        if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'activated') window.location.reload();
                                });
                            }
                        });
                    })
                    .catch(err => console.warn('SW falhou:', err));
            });
        });
    }
</script>
</body>
</html>